<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>TableApp 完全版</title>
  <style>
    .table-container {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
      border: 1px solid #ccc;
      padding: 4px 8px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sort-btn {
      margin-left: 5px;
      font-size: 12px;
    }

    tr.selected {
      background-color: #d0ebff;
    }

    .paging-controls {
      margin-top: 10px;
    }

    .preview img {
      max-width: 200px;
      max-height: 200px;
      border: 1px solid #ccc;
    }

    tbody {
      display: block;
      width: 100%;
    }

    thead,
    tbody tr {
      display: table;
      table-layout: fixed;
      width: 100%;
    }
  </style>
</head>

<body>

  <div class="table-container">
    <table id="data-table"></table>
  </div>

  <div class="paging-controls">
    <button id="prev-page">Prev</button>
    <input id="current-page" type="number" value="1" min="1" style="width:50px;"> /
    <span id="total-pages">1</span>
    <button id="next-page">Next</button>
    <select id="page-size">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
    </select> 件表示
  </div>

  <div class="preview">
    <img id="row-preview" src="" alt="Preview">
  </div>

  <script>
    // --- サンプル外部データ ---
    const columns = [
      { key: "id", label: "ID" },
      { key: "name", label: "Name" },
      { key: "age", label: "Age" },
      { key: "score", label: "Score" },
      { key: "img", label: "Image" }
    ];

    const NUM_ROWS = 5000;
    const names = ["Alice", "Bob", "Charlie", "David", "Eve", "Frank", "Grace", "Hannah", "Ivy", "Jack"];
    const rows = [];
    for (let i = 1; i <= NUM_ROWS; i++) {
      const name = names[Math.floor(Math.random() * names.length)];
      const age = 18 + Math.floor(Math.random() * 50);
      const score = Math.floor(Math.random() * 100);
      rows.push({ id: i, name: name, age: age, score: score, img: `img${(i % 10) + 1}.jpg` });
    }
    const tableData = { columns: columns, rows: rows };

    // 列ごとのフィルタータイプ（外部 JS で設定想定）
    const filterTypes = { id: "select", name: "select", age: "range", score: "range", img: "select" };

    var TableApp = TableApp || {};
    TableApp.Table = class {
      /**
       * @param {HTMLTableElement} table 
       * @param {Object} tableData - {columns:[{key,label}], rows:[{...}]} 
       * @param {Object} filterTypes - {key: "select"|"range"}
       * @param {number} pageSize - 1ページあたり表示行数
       */
      constructor(table, tableData, filterTypes = {}, pageSize = 10) {
        this.table = table;
        this.tbody = table.createTBody();
        this.columns = tableData.columns;
        this.rowsData = tableData.rows;
        this.filterTypes = filterTypes;
        this.pageSize = pageSize;

        this.sortStates = {};
        this.filters = {};
        this.currentPage = 1;
        this.selectedIndex = 0;
        this.imgPreview = document.getElementById("row-preview");

        this.rows = this.rowsData.map((r, i) => ({
          element: null,
          data: r,
          index: i
        }));

        this.#renderHeader();
        this.#initSortButtons();
        this.#initFilters();
        this.#initPaging();
        this.#initRowSelection();
        this.render();
      }

      #renderHeader() {
        const thead = this.table.createTHead();
        const tr = thead.insertRow();
        this.columns.forEach(c => {
          const th = document.createElement("th");
          th.textContent = c.label + " ";
          const btn = document.createElement("button");
          btn.className = "sort-btn"; btn.dataset.key = c.key; btn.textContent = "△▽";
          th.appendChild(btn);
          tr.appendChild(th);
        });

        const filterTr = thead.insertRow();
        this.columns.forEach(c => {
          const th = document.createElement("th");
          const type = this.filterTypes[c.key] || "select";
          if (type === "range") {
            const minInput = document.createElement("input");
            minInput.type = "number"; minInput.dataset.key = c.key; minInput.dataset.type = "min"; minInput.placeholder = "Min"; minInput.style.width = "45%";
            const maxInput = document.createElement("input");
            maxInput.type = "number"; maxInput.dataset.key = c.key; maxInput.dataset.type = "max"; maxInput.placeholder = "Max"; maxInput.style.width = "45%";
            th.appendChild(minInput); th.appendChild(document.createTextNode(" - ")); th.appendChild(maxInput);
          } else {
            const inp = document.createElement("input");
            inp.type = "text"; inp.dataset.key = c.key; inp.dataset.type = "select"; inp.placeholder = "Filter";
            th.appendChild(inp);
          }
          filterTr.appendChild(th);
        });
      }

      #initSortButtons() {
        this.table.querySelectorAll(".sort-btn").forEach(btn => {
          const key = btn.dataset.key;
          this.sortStates[key] = "none";
          btn.addEventListener("click", () => {
            this.sortStates[key] = this.sortStates[key] === "none" ? "asc" : this.sortStates[key] === "asc" ? "desc" : "none";
            Object.keys(this.sortStates).forEach(k => { if (k !== key) this.sortStates[k] = "none" });
            this.#updateSortIcons();
            this.currentPage = 1; this.render();
          });
        });
      }

      #updateSortIcons() {
        this.table.querySelectorAll(".sort-btn").forEach(btn => {
          const s = this.sortStates[btn.dataset.key];
          btn.textContent = s === "none" ? "△▽" : s === "asc" ? "▲▽" : "△▼";
        });
      }

      #initFilters() {
        this.table.querySelectorAll("input").forEach(inp => {
          const key = inp.dataset.key;
          const type = inp.dataset.type;
          if (!this.filters[key]) this.filters[key] = { select: null, min: null, max: null };
          inp.addEventListener("input", () => {
            this.filters[key][type] = type === "min" || type === "max" ? Number(inp.value) || null : inp.value || null;
            this.currentPage = 1; this.render();
          });
        });
      }

      #initPaging() {
        const prev = document.getElementById("prev-page");
        const next = document.getElementById("next-page");
        const cur = document.getElementById("current-page");
        const total = document.getElementById("total-pages");
        const pageSizeSel = document.getElementById("page-size");

        prev.addEventListener("click", () => { if (this.currentPage > 1) { this.currentPage--; this.render(); } });
        next.addEventListener("click", () => { const tp = Math.ceil(this.filteredRows.length / this.pageSize); if (this.currentPage < tp) { this.currentPage++; this.render(); } });
        cur.addEventListener("change", () => { const tp = Math.ceil(this.filteredRows.length / this.pageSize); this.currentPage = Math.min(Math.max(1, Number(cur.value)), tp); this.render(); });
        pageSizeSel.addEventListener("change", () => { this.pageSize = Number(pageSizeSel.value); this.currentPage = 1; this.render(); });

        this.pageUI = { cur, total };
      }

      #initRowSelection() {
        this.table.addEventListener("click", e => {
          const tr = e.target.closest("tr"); if (!tr) return;
          const idx = this.filteredRows.findIndex(r => r.element === tr);
          if (idx !== -1) { this.selectedIndex = idx; this.#updateSelection(); }
        });
        document.addEventListener("keydown", e => {
          if (e.key === "ArrowUp" || e.key === "ArrowDown") {
            e.preventDefault();
            this.selectedIndex += e.key === "ArrowDown" ? 1 : -1;
            this.selectedIndex = Math.max(0, Math.min(this.selectedIndex, this.filteredRows.length - 1));
            this.#updateSelection(true);
          }
        });
      }

      #updateSelection(scroll = false) {
        this.filteredRows.forEach((r, i) => r.element.classList.toggle("selected", i === this.selectedIndex));
        const sel = this.filteredRows[this.selectedIndex];
        if (sel && this.imgPreview) { this.imgPreview.src = sel.data.img || ""; }
        if (scroll && sel) sel.element.scrollIntoView({ block: "nearest" });
      }

      #passesFilter(row) {
        return Object.keys(this.filters).every(k => {
          const val = row.data[k], f = this.filters[k];
          return (!f.select || String(val) === String(f.select)) &&
            (!f.min || Number(val) >= f.min) &&
            (!f.max || Number(val) <= f.max);
        });
      }

      #compare(a, b) {
        const sKey = Object.keys(this.sortStates).find(k => this.sortStates[k] !== "none");
        if (!sKey) return a.index - b.index;
        const order = this.sortStates[sKey]; const va = a.data[sKey]; const vb = b.data[sKey];
        const na = parseFloat(va), nb = parseFloat(vb); const numeric = !isNaN(na) && !isNaN(nb);
        if (numeric) return order === "asc" ? na - nb : nb - na;
        return order === "asc" ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
      }

      render() {
        this.filteredRows = this.rows.filter(r => this.#passesFilter(r)).sort((a, b) => this.#compare(a, b));
        const totalPages = Math.ceil(this.filteredRows.length / this.pageSize) || 1;
        if (this.currentPage > totalPages) this.currentPage = totalPages;
        const startIdx = (this.currentPage - 1) * this.pageSize;
        const endIdx = Math.min(startIdx + this.pageSize, this.filteredRows.length);
        const pageRows = this.filteredRows.slice(startIdx, endIdx);

        this.tbody.innerHTML = "";
        pageRows.forEach(r => {
          const tr = document.createElement("tr");
          this.columns.forEach(c => {
            const td = document.createElement("td");
            td.textContent = r.data[c.key];
            tr.appendChild(td);
          });
          r.element = tr;
          this.tbody.appendChild(tr);
        });

        this.selectedIndex = 0;
        this.#updateSelection();
        this.pageUI.cur.value = this.currentPage;
        this.pageUI.total.textContent = totalPages;
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      new TableApp.Table(document.getElementById("data-table"), tableData, filterTypes, 10);
    });
  </script>

</body>

</html>