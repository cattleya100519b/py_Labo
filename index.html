<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TableApp Demo</title>
<style>
/* テーブル全体 */
table {
  border-collapse: collapse;
  width: 100%;
  table-layout: fixed; /* 固定幅 */
}

th, td {
  border: 1px solid #ccc;
  padding: 4px 8px;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ソートボタン */
.sort-btn {
  margin-left: 5px;
  font-size: 12px;
}

/* フィルター行 */
.filter-row input {
  width: 90%;
  box-sizing: border-box;
  padding: 2px 4px;
  font-size: 12px;
}

/* 選択行 */
tr.selected {
  background-color: #d0ebff;
}

/* ページング */
.paging-controls {
  margin-top: 10px;
}

/* プレビュー */
.preview {
  margin-top: 10px;
}

.preview img {
  border: 1px solid #ccc;
}

/* 仮想スクロール用 padding */
tbody {
  display: block;
  width: 100%;
}

thead, tbody tr {
  display: table;
  table-layout: fixed;
  width: 100%;
}
</style>
</head>
<body>

<div class="table-container" style="height:300px; overflow-y:auto; border:1px solid #ccc;">
  <table id="data-table"></table>
</div>

<div class="paging-controls">
  <button id="prev-page">Prev</button>
  <input id="current-page" type="number" value="1" min="1" style="width:50px;">
  / <span id="total-pages">1</span>
  <button id="next-page">Next</button>
  <select id="page-size">
    <option value="5">5</option>
    <option value="10" selected>10</option>
    <option value="20">20</option>
  </select>
  件表示
</div>

<div class="preview">
  <img id="row-preview" src="" alt="Preview" style="max-width:200px; max-height:200px;">
</div>

<script>
var TableApp = TableApp || {};

/**
 * TableApp.Table
 * @class
 * @classdesc JSON データからテーブルを生成し、ソート・フィルター・ページング・仮想スクロール・選択行・画像プレビューを管理するクラス
 */
TableApp.Table = class {
  /**
   * TableApp.Table コンストラクタ
   * @param {HTMLTableElement} table - 対象テーブル
   * @param {Object} tableData - テーブルデータ {columns:[{key,label}], rows:[{…}]}
   * @param {Object} filterTypes - {colKey:"select"|"range"} 列ごとのフィルター種別
   * @param {number} pageSize - 1ページの行数
   */
  constructor(table, tableData, filterTypes={}, pageSize=10){
    this.table = table;
    this.tbody = table.createTBody();
    this.columns = tableData.columns;
    this.rowsData = tableData.rows;
    this.filterTypes = filterTypes;
    this.pageSize = pageSize;

    /** @type {Object.<string,"none"|"asc"|"desc">} */
    this.sortStates = {};
    /** @type {Object.<string,{select: string|null, min: number|null, max: number|null}>} */
    this.filters = {};
    this.currentPage = 1;
    this.selectedIndex = 0;

    /** @type {HTMLImageElement|null} */
    this.imgPreview = document.getElementById("row-preview");

    /** @type {Array<{element: HTMLTableRowElement|null, cells:Array, data:Object, index:number}>} */
    this.rows = this.rowsData.map((r,i)=>({
      element: null,
      cells: this.columns.map(c=>r[c.key]),
      data: r,
      index: i
    }));

    // 仮想スクロール関連
    this.rowHeight = 30;
    this.bufferRows = 5;
    this.visibleStart = 0;
    this.visibleEnd = 0;

    // 初期化
    this.#renderHeader();
    this.#initSortButtons();
    this.#initFilters();
    this.#initPaging();
    this.#initRowSelection();
    this.#initScroll();
    this.render();
  }

  /**
   * ヘッダーとフィルター行を生成
   * @private
   * @returns {void}
   */
  #renderHeader(){
    const thead = this.table.createTHead();
    const tr = thead.insertRow();
    this.columns.forEach(c=>{
      const th = document.createElement("th");
      th.textContent = c.label + " ";
      const btn = document.createElement("button");
      btn.className="sort-btn";
      btn.dataset.key=c.key;
      btn.textContent="△▽";
      th.appendChild(btn);
      tr.appendChild(th);
    });

    // フィルター行
    const filterTr = thead.insertRow();
    this.columns.forEach(c=>{
      const th = document.createElement("th");
      const type = this.filterTypes[c.key] || "select";
      if(type==="range"){
        const minInput = document.createElement("input");
        minInput.type="number"; minInput.dataset.key=c.key; minInput.dataset.type="min";
        minInput.placeholder="Min"; minInput.style.width="45%";
        const maxInput = document.createElement("input");
        maxInput.type="number"; maxInput.dataset.key=c.key; maxInput.dataset.type="max";
        maxInput.placeholder="Max"; maxInput.style.width="45%";
        th.appendChild(minInput); th.appendChild(document.createTextNode(" - ")); th.appendChild(maxInput);
      } else {
        const inp = document.createElement("input");
        inp.type="text"; inp.dataset.key=c.key; inp.dataset.type="select"; inp.placeholder="Filter";
        th.appendChild(inp);
      }
      filterTr.appendChild(th);
    });
  }

  /**
   * ソートボタン初期化
   * @private
   * @returns {void}
   */
  #initSortButtons(){
    this.table.querySelectorAll(".sort-btn").forEach(btn=>{
      const key = btn.dataset.key;
      this.sortStates[key]="none";
      btn.addEventListener("click", ()=>{
        // ソート状態を循環
        this.sortStates[key] = this.sortStates[key]==="none"?"asc":this.sortStates[key]==="asc"?"desc":"none";
        // 他列リセット
        Object.keys(this.sortStates).forEach(k=>{if(k!==key) this.sortStates[k]="none"});
        this.#updateSortIcons();
        this.currentPage=1; this.render();
      });
    });
  }

  /**
   * ソートアイコン更新
   * @private
   * @returns {void}
   */
  #updateSortIcons(){
    this.table.querySelectorAll(".sort-btn").forEach(btn=>{
      const s = this.sortStates[btn.dataset.key];
      btn.textContent = s==="none"?"△▽":s==="asc"?"▲▽":"△▼";
    });
  }

  /**
   * フィルター初期化
   * @private
   * @returns {void}
   */
  #initFilters(){
    this.table.querySelectorAll("input").forEach(inp=>{
      const key=inp.dataset.key;
      const type=inp.dataset.type;
      if(!this.filters[key]) this.filters[key]={select:null,min:null,max:null};
      inp.addEventListener("input", ()=>{ this.filters[key][type]=inp.value||null; this.currentPage=1; this.render(); });
    });
  }

  /**
   * ページング初期化
   * @private
   * @returns {void}
   */
  #initPaging(){
    const prev=document.getElementById("prev-page");
    const next=document.getElementById("next-page");
    const cur=document.getElementById("current-page");
    const total=document.getElementById("total-pages");
    const pageSizeSel=document.getElementById("page-size");

    prev.addEventListener("click", ()=>{if(this.currentPage>1){this.currentPage--;this.render();}});
    next.addEventListener("click", ()=>{const tp=Math.ceil(this.filteredRows.length/this.pageSize); if(this.currentPage<tp){this.currentPage++;this.render();}});
    cur.addEventListener("change", ()=>{const tp=Math.ceil(this.filteredRows.length/this.pageSize); this.currentPage=Math.min(Math.max(1,Number(cur.value)),tp); this.render();});
    pageSizeSel.addEventListener("change", ()=>{this.pageSize=Number(pageSizeSel.value); this.currentPage=1; this.render();});

    this.pageUI={cur,total};
  }

  /**
   * 行選択初期化（クリック + 矢印キー）
   * @private
   * @returns {void}
   */
  #initRowSelection(){
    this.table.addEventListener("click", e=>{
      const tr=e.target.closest("tr");
      if(!tr) return;
      const idx=this.filteredRows.findIndex(r=>r.element===tr);
      if(idx!==-1){this.selectedIndex=idx; this.#updateSelection();}
    });
    document.addEventListener("keydown", e=>{
      if(e.key==="ArrowUp"||e.key==="ArrowDown"){
        e.preventDefault();
        this.selectedIndex+=e.key==="ArrowDown"?1:-1;
        this.selectedIndex=Math.max(0,Math.min(this.selectedIndex,this.filteredRows.length-1));
        this.#updateSelection(true);
      }
    });
  }

  /**
   * 選択行を更新
   * @private
   * @param {boolean} scroll - trueなら選択行をスクロール位置に移動
   * @returns {void}
   */
  #updateSelection(scroll=false){
    this.filteredRows.forEach((r,i)=>r.element.classList.toggle("selected",i===this.selectedIndex));
    const sel=this.filteredRows[this.selectedIndex];
    if(sel && this.imgPreview){ this.imgPreview.src=sel.data.img||""; }
    if(scroll && sel) sel.element.scrollIntoView({block:"nearest"});
  }

  /**
   * フィルター判定
   * @private
   * @param {Object} row - 行オブジェクト
   * @returns {boolean} - フィルター通過なら true
   */
  #passesFilter(row){
    return Object.keys(this.filters).every(k=>{
      const v=row.data[k]; const f=this.filters[k];
      return (!f.select || v==f.select) && (!f.min||v>=f.min) && (!f.max||v<=f.max);
    });
  }

  /**
   * ソート比較関数
   * @private
   * @param {Object} a - 行オブジェクト
   * @param {Object} b - 行オブジェクト
   * @returns {number} - 比較結果
   */
  #compare(a,b){
    const sKey=Object.keys(this.sortStates).find(k=>this.sortStates[k]!=="none");
    if(!sKey) return a.index-b.index;
    const order=this.sortStates[sKey]; const va=a.data[sKey]; const vb=b.data[sKey];
    const na=parseFloat(va),nb=parseFloat(vb); const numeric=!isNaN(na)&&!isNaN(nb);
    if(numeric) return order==="asc"?na-nb:nb-na;
    return order==="asc"?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va));
  }

  /**
   * 列幅を thead と tbody で同期
   * @private
   * @returns {void}
   */
  #syncColumnWidths(){
    const ths = this.table.tHead.rows[0].cells;
    const tbodyRow = this.tbody.firstChild;
    if(!tbodyRow) return;
    Array.from(ths).forEach((th,i)=>{
      const td = tbodyRow.cells[i];
      if(td) td.style.width=th.offsetWidth+"px";
    });
  }

  /**
   * 仮想スクロール用描画
   * @private
   * @returns {void}
   */
  #renderVirtual(){
    const startIdx = Math.max(0,this.visibleStart-this.bufferRows);
    const endIdx = Math.min(this.filteredRows.length,this.visibleEnd+this.bufferRows);
    this.tbody.innerHTML="";
    for(let i=startIdx;i<endIdx;i++){
      this.tbody.appendChild(this.filteredRows[i].element);
    }
    this.tbody.style.paddingTop=startIdx*this.rowHeight+"px";
    this.tbody.style.paddingBottom=(this.filteredRows.length-endIdx)*this.rowHeight+"px";
  }

  /**
   * スクロール初期化（仮想スクロール対応）
   * @private
   * @returns {void}
   */
  #initScroll(){
    const container=this.table.parentElement;
    container.addEventListener("scroll", ()=>{
      const scrollTop = container.scrollTop;
      const rowsPerView = Math.ceil(container.clientHeight/this.rowHeight);
      this.visibleStart=Math.floor(scrollTop/this.rowHeight);
      this.visibleEnd=this.visibleStart+rowsPerView;
      this.#renderVirtual();
    });
  }

  /**
   * テーブル描画
   * @public
   * @returns {void}
   */
  render(){
    // フィルター通過 + ソート済み
    this.filteredRows=this.rows.filter(r=>this.#passesFilter(r)).sort((a,b)=>this.#compare(a,b));

    // ページ情報更新
    const totalPages=Math.ceil(this.filteredRows.length/this.pageSize);
    this.pageUI.total.textContent=totalPages;
    this.pageUI.cur.value=this.currentPage;

    const start=(this.currentPage-1)*this.pageSize;
    const end=Math.min(start+this.pageSize,this.filteredRows.length);

    // tbody に必要な行のみ生成
    for(let i=start;i<end;i++){
      let r=this.filteredRows[i];
      if(!r.element){
        const tr=document.createElement("tr");
        this.columns.forEach(c=>{const td=document.createElement("td"); td.textContent=r.data[c.key]; tr.appendChild(td);});
        tr.dataset.img=r.data.img||"";
        r.element=tr;
      }
    }

    this.visibleStart=start; this.visibleEnd=end;
    this.#renderVirtual();
    this.#syncColumnWidths();

    this.selectedIndex=Math.min(this.selectedIndex,this.filteredRows.length-1);
    this.#updateSelection();
  }
};
</script>
<!-- JSON データ例 -->
<script>
// 列定義
const columns = [
  {key:"id", label:"ID"},
  {key:"name", label:"Name"},
  {key:"age", label:"Age"},
  {key:"score", label:"Score"},
  {key:"img", label:"Image"}
];

// ダミーデータ生成
const NUM_ROWS = 5000;
const names = ["Alice","Bob","Charlie","David","Eve","Frank","Grace","Hannah","Ivy","Jack"];
const tableRows = [];

for(let i=1;i<=NUM_ROWS;i++){
  const name = names[Math.floor(Math.random()*names.length)];
  const age = 18 + Math.floor(Math.random()*50);
  const score = Math.floor(Math.random()*100);
  tableRows.push({
    id:i,
    name:name,
    age:age,
    score:score,
    img:`img${(i%10)+1}.jpg`
  });
}

// JSON データ
const tableData = { columns: columns, rows: tableRows };

// フィルタータイプ
const filterTypes = {
  id:"select",
  name:"select",
  age:"range",
  score:"range",
  img:"select"
};

// テーブル初期化
document.addEventListener("DOMContentLoaded", ()=>{
  new TableApp.Table(document.getElementById("data-table"), tableData, filterTypes, 20);
});
</script>

</body>
</html>